
<main role="main" class="-rel">




  <section class="messages-main">

    <div class="messages-sidebar">
      	<div class="messages-sidebar-header -clear-after">
      		<div class="messages-search -col-7"></div>
      		<div class="messages-new -pl1 -col-5"></div>
      	</div>
    	<div class="white-grad side-grad"><div></div></div>

      	<div class="messages-list">

      	</div>
    </div>
    <div class="messages-body">
	<div class="no-messages">
		<p>Select a conversation from the list to start messaging.</p>
	</div>
    <div class="messages-body-container">

    	<div class="messages-body-header">
    		<div class="m-action">
    			<span class="conversation-title">Conversation with Pepe Pecas <a href="#">one link</a> and after a while <a href="#"><b>another bold</b></a></span>
      			<div class="action-icon delete-thread">
      				<svg class="">
      					<use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#svg-trash"></use>
      				</svg>
      			</div>
      		</div>
      		<div class="m-new">
      			<div class="-col-3">
      				<span>New message to:</span>
      			</div>
      			<div class="-col-9">
	    			<div class="form-field">
	    				<div class="cv-input small hollow">
	    					<input class="search-users" type="text" placeholder="Type name">
	    				</div>
	    			</div>
	    			<ul class="search-users-result">
	    			</ul>
    			</div>
      		</div>
    	</div>
    	<div class="messages-container">
    		<div class="white-grad"><div></div></div>
    		<div class="messages-conversation">
    			<div class="msgs">
    				<!-- messages container -->
    			</div>
    		</div>

    		<div class="message-create">

    		</div>
    	</div>

    </div>
    </div>

  </section>

</main>

<script>
    // App
    var ns = [];
    <% if (typeof notifications !== "undefined") { %>
      ns = <%= JSON.stringify(notifications) %>;
    <% } %>
    var App = new CV.App({
      notifications : ns,
      currentPerson : currentPerson
    });
    App.addInteractiveSidebar();

  	$( document ).ready(function() {

  		//resizeMessages();

        var threadsContainer = new CV.ThreadsContainer({
            name : 'threadContainer',
            element : $(document.querySelector('.messages-main')),
            threads : <%= JSON.stringify(threads) %>,
            currentPerson : <%= JSON.stringify(currentPerson) %>
        });

        var threadHash = window.location.hash.substr(1);

        if (threadHash){
        	threadsContainer.element.find('.messages-list #'+threadHash).click();
        }
        //threadsContainer.resizeMessages();
	});

  	var searchElement = document.querySelector('.messages-search');
  	var createElement = $(document.querySelector('.message-create'));

  	var messagesMainEl = $(document.querySelector('.messages-main'));
  	var messagesContainerEl = $(document.querySelector('.messages-container'));
  	var noMessagesEl = $(document.querySelector('.no-messages'));
  	var messagesBodyHeaderEl = $(document.querySelector('.messages-body-header'));
  	var messagesBodyContainerEl = $(document.querySelector('.messages-body-container'));
  	var threadListEl = $(document.querySelector('.messages-list'));
  	var messageListEl = $(document.querySelector('.msgs'));

  	var searchUsersResultEl = $(document.querySelector('.search-users-result'));

  	var threads = <%= JSON.stringify(threads) %>;
	var threadsObj = {};

	var currentThreadID;
	var currentPersonID = '<%= currentPerson.id %>';
	var otherPersonID;
	var currentPersonProfileName = '<%= currentPerson.profileName %>';
	var token = '<%= csrfToken %>';
	var relatedPersons;
	var isNewThread = false;

	var messageText = $('<div class="message-text">\
			      			<div class="message-info">\
							    <img class="" src="/img/sample/avatars/org-06.png" alt="">\
							    <div class="message-data">\
				      				<h3>Chu Vaca </h3>\
				      				<span>• May 5th, 2015 • 7:32 PM</span>\
				      				<p>May the taco be with you lorem ipsum dolor sit ameret lorem ipsum dolor sit ameret lorem ipsum dolor sit ameret lorem ipsum dolor sit ameret.</p>\
				      			</div>\
			      			</div>\
			      		</div>');

  	var messageSide = $('<div class="message-side">\
			      			<div class="message-info">\
							    <img class="" src="/img/sample/avatars/org-06.png" alt="">\
				      			<h3></h3>\
				      			<span></span>\
			      			</div>\
			      			<div class="actions">\
			      				<span></span>\
			      			</div>\
			      		</div>');

  	var messageTextFull = $('<div class="message-text">\
				      			<div class="message-info">\
								    <img class="" src="/img/sample/avatars/org-06.png" alt="">\
					      			<div class="message-data">\
					      				<h3>Chu Vaca </h3>\
					      				<span>• May 5th, 2015 • 7:32 PM</span>\
					      				<p>May the taco be with you lorem ipsum dolor sit ameret lorem ipsum dolor sit ameret lorem ipsum dolor sit ameret lorem ipsum dolor sit ameret.</p>\
					      				<div class="message-notification">\
					      					<p>Julia has requested to become a contributor for The Extended Effects of the Fukushima Disaster. If you grant access, Julia will be able to <a href="#">one link</a> and after a while another bold. <a href="#"><b>Go to this Voice\'s settings ›</b></a></p>\
					      					<div class="message-notification-actions"></div>\
					      				</div>\
					      			</div>\
				      			</div>\
				      		</div>');



	var mi = 1;

	function postMessage(){
		var postMessageUrl = '/'+ currentPersonProfileName + '/messages/'+ currentThreadID;

		$.ajax({
          type: "POST",
          url: postMessageUrl,
          headers: { 'csrf-token': token },
          data: { message : document.querySelector('.message-create textarea').value},
          success: function(data) {
            document.querySelector('.message-create textarea').value = "";
            var messageEl = messageText.clone();
			messageEl.find('.message-data h3').text('<%= currentPerson.name %>' + " " +
				'<%= currentPerson.lastname %>');
			messageEl.find('.message-data span').text(moment(new Date().toISOString()).
				format('• MMMM Do, YYYY • h:mm a'));
			messageEl.find('.message-data p').text(data.message);
			messageListEl.append(messageEl);
			$('.messages-conversation').scrollTop(10000);
          }
        });
	}



	function createThread () {
		var postMessageUrl = '/'+ currentPersonProfileName + '/messages';
		//console.log(currentPersonID);
		//console.log(otherPersonID);
		$.ajax({
          type: "POST",
          url: postMessageUrl,
          headers: { 'csrf-token': token },
          data: {
          	message : document.querySelector('.message-create textarea').value,
          	senderEntityId : currentPersonID,
          	receiverEntityId : otherPersonID
          },
          success: function(data) {
          	document.querySelector('.message-create textarea').value = "";
          	currentThreadID = data.id;
          	addThread(data, true);
          	showSidebar();
          	//postMessage();
            console.log(data);
          }
        });

	}



	function showThread (threadId, threadPartnerName, threadEl){
		isNewThread = false;
		//console.log(threadId);
		currentThreadID = threadId;
		console.log(threadId);
		noMessagesEl.hide();
		messagesBodyContainerEl.addClass('active');
		messagesContainerEl.show();
		messageListEl.empty();

		messagesBodyHeaderEl.find('.m-action').show();
		messagesBodyHeaderEl.find('.m-new').hide();
		messagesBodyHeaderEl.find('span.conversation-title').text('Conversation with ' + threadPartnerName);
		messagesBodyHeaderEl.find('.delete-thread').show().attr('data-id', threadId);

		resizeMessages();

		if (!$(threadEl).hasClass('updated')){
			$(threadEl).addClass('updated');
			var updateThreadUrl = '/'+ currentPersonProfileName + '/messages/'+ threadId;
			console.log(updateThreadUrl); //  /jack-johnson/messages/K8adgKWgZPlo
			$.ajax({
	          type: "PUT",
	          url: updateThreadUrl,
	          headers: { 'csrf-token': token },
	          success: function(data) {
	            console.log('Thread updated');
	          }
	        });
		}



		Object.keys(threadsObj[threadId].messages).sort().reverse().forEach(function(messageId, i) {
          	var messageObj = threadsObj[threadId].messages[messageId];
          	var messageEl;

          	switch(messageObj.type) {
			    case 'message':

					messageEl = messageText.clone();
			        break;

			    case 'invitation_organization':

				    messageEl = messageTextFull.clone();
					var messageNotificationText = messageObj.senderEntity.name + " " + messageObj.senderEntity.lastname + ' has requested you to become a contributor for <b>'
							+ messageObj.organization.name +
							'</b> organization. For more information you can <a href="/'
							+ messageObj.organization.profileName +
							'"><b>Go to this Organization ›</b></a>';

					messageEl.find('.message-notification p').html(messageNotificationText);
			        break;

			    case 'invitation_voice':

				    messageEl = messageTextFull.clone();
					var messageNotificationText = messageObj.senderEntity.name + " " + messageObj.senderEntity.lastname + ' has requested you to become a contributor for the voice <b>'
							+ messageObj.voice.title +
							'</b>. For more information you can <a href="/'
							+ messageObj.senderEntity.profileName + '/' + messageObj.voice.slug +
							'"><b>Go to this Voice ›</b></a>';

					messageEl.find('.message-notification p').html(messageNotificationText);
			        break;

			    case 'request_organization':

				    messageEl = messageTextFull.clone();
					var messageNotificationText = messageObj.senderEntity.name + " " + messageObj.senderEntity.lastname + ' has requested you to become a contributor for <b><a href="/'+ messageObj.organization.profileName +'">'
							+ messageObj.organization.name +
							'</a></b> organization. For more information you can <a href="/'
							+ messageObj.senderEntity.profileName +
							'"><b>Go to his/her profile ›</b></a>';

					messageEl.find('.message-notification p').html(messageNotificationText);
			        break;

			    case 'request_voice':

				    messageEl = messageTextFull.clone();
					var messageNotificationText = messageObj.senderEntity.name + " " + messageObj.senderEntity.lastname + ' has requested you to become a contributor for the voice <b><a href="/' + messageObj.senderEntity.profileName + '/' + messageObj.voice.slug + '">'
							+ messageObj.voice.title +
							'</a></b>. For more information you can <a href="/'
							+ messageObj.senderEntity.profileName +
							'"><b>Go to his/her profile ›</b></a>';

					messageEl.find('.message-notification p').html(messageNotificationText);
			        break;

			    default:
			        //default code block
			}

          	if (messageObj.type.search('invitation') !== -1){

				var btnMultipleOptions = {
					"1": {label: 'Accept', name: 'accept'},
					"2": {label: 'Accept as an Anonymous Member', name: 'anonymous'},
					"3": {label: 'Refuse', name: 'refuse'}
				};

				var messageActions = new CV.Button({
					style   : 'tiny',
					type    : 'multiple',
					name    : 'buttonMultiple',
					options : btnMultipleOptions
				}).render(messageEl.find('.message-notification-actions'));

				// ************   Message button actions *******************

				messageActions.accept.on('click', function(){
                    var url = '/' + currentPersonProfileName + '/messages/' + messageObj.threadId + '/' + messageObj.id  +'/acceptInvite';

                    $.ajax({
                        method : 'GET',
                        url : url,
                        contentType : 'json',
                        succes : function(data) {
                            console.log(data)
                        },
                        error : function(err) {
                            console.error(err);
                        }
                    })
					console.log('-- Accept --');
					console.log('message Id: ' + messageObj.id);
					console.log('thread Id: ' + messageObj.threadId);
					console.log('message Type: ' + messageObj.type);
				});

				messageActions.anonymous.on('click', function(){
					console.log('-- Accept as an Anonymous Member --');
					console.log('message Id: ' + messageObj.id);
					console.log('thread Id: ' + messageObj.threadId);
					console.log('message Type: ' + messageObj.type);
				});

				messageActions.refuse.on('click', function(){
					console.log('-- Refuse --');
					console.log('message Id: ' + messageObj.id);
					console.log('thread Id: ' + messageObj.threadId);
					console.log('message Type: ' + messageObj.type);
				});

			}

			messageEl.find('.message-data h3').text(messageObj.senderEntity.name + " " + messageObj.senderEntity.lastname);
			messageEl.find('.message-data span').text(moment(new Date(messageObj.createdAt).toISOString()).format('• MMMM Do, YYYY • h:mm a'));
			messageEl.find('.message-data > p').text(messageObj.message);
			messageListEl.append(messageEl);

       	});

	}

	function resizeMessages () {
console.log('view');
  		var chatHeight = $(window).height() + $('.cv-main-header').outerHeight();
		$('.messages-sidebar, .messages-body, .messages-body-container').height(chatHeight);
		console.log('chatHeight: ' + chatHeight);
		var sideMessagesHeight = chatHeight - $('.messages-sidebar-header').outerHeight();
		$('.messages-list').css({'overflow-y':'scroll', 'height': sideMessagesHeight+'px'});
		var bodyMessagesHeight = chatHeight - ($('.messages-body-header').outerHeight() + $('.message-create').outerHeight());
		$('.messages-conversation').height(bodyMessagesHeight);


  	}

</script>





