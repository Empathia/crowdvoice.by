<main role="main" class="cv-main-profile profile-user profile-page -rel">

  <section class="profile-intro -rel">

    <% if (organization.background.exists('big')){ %>
      <div class="profile-background-cover -img-cover" style="background-image: url(<%= organization.background.url('big') %>);"></div>
    <% }else{ %>
      <div class="profile-background-cover -colored-background"></div>
    <% } %>

    <% if (organization.image.exists('medium')){ %>
      <img class="profile-image" src="<%= organization.image.url('medium') %>">
    <% }else{ %>
      <img class="profile-image" src="/img/placeholder-image.png">
    <% } %>

    <div class="pan-separator -rel">

      <div class="profile-tw">@<%= organization.profileName %></div>
      <h1 class="profile-heading -font-bold -m0"><%= organization.name %> </h1>
      <p class="profile-description"><%= organization.description %></p>

      <div class="profile-card-activity">

        <% if (organization.location){ %>
          <div class="profile-card-activity-repost -inline-block -mr1">
            <svg class="profile-card-activity-svg"><use xlink:href="#svg-location"></use></svg>
            <span class="profile-card-activity-label"><%= organization.location %></span>
          </div>
        <% } %>

        <div class="profile-card-activity-saved -inline-block  -mr1 -ml1">
          <svg class="profile-card-activity-svg"><use xlink:href="#svg-clock"></use></svg>
          <span class="profile-card-activity-label user-date"></span>
          <script>
            var userDate = moment(new Date('<%= organization.createdAt %>').toISOString()).format('MMMM, YYYY');
            $('.user-date').text('Joined ' + userDate );
          </script>
        </div>

      </div>

    </div>
  </section>

  <article role="article" class="stats profile-stats profile-menu bg-fix -row -rel">
      <div class="profile-tabs">
        <div class="stats-col active -menu-tab -inline-block">
          <p class="stats-number counter-voices -font-bold">0</p>
          <p class="stats-label">Voices</p>
        </div>
        <div class="stats-col -menu-tab -inline-block">
          <p class="stats-number counter-followers -font-bold">0</p>
          <p class="stats-label">Followers</p>
        </div>
        <div class="stats-col -menu-tab -inline-block">
          <p class="stats-number counter-following -font-bold">0</p>
          <p class="stats-label">Following</p>
        </div>
      </div>
      <div class="profile-actions">
        <span class="-pr1 p-buttons"></span>
        <span class="p-select"></span>
      </div>
  </article>

  <div class="profile-list-type-container -rel"  style="display: none;">
    <div class="profile-list-type">
      <div class="style-grid active"><img src="/img/sample/icons/grid.png" alt=""></div>
      <div class="style-list"><img src="/img/sample/icons/list.png" alt=""></div>
    </div>
  </div>

  <section class="profile-content-body profile-menu-content -rel">

    <div class="active -menu-tab-content">
      <h2 class="profile-subheading -font-bold -m0">Voices</h2>
      <hr>
      <div class="-row profile-voices-container profile-container">
        <!-- voices -->
      </div>
    </div>

    <div class=" -menu-tab-content">
      <h2 class="profile-subheading -font-bold -m0">Followers</h2>
      <hr>
      <br>
      <div class="-row profile-followers-container profile-container">
        <!-- followers -->

      </div>
    </div>

    <div class=" -menu-tab-content">
      <h2 class="profile-subheading -font-bold -m0">Following</h2>
      <span class="entities-voices-select -pl1"></span>
      <hr>
      <div class="-row profile-following-container  profile-container">
        <div class="voices-followed" style="display: none;"></div>
        <br>
        <div class="entities-followed"></div>
      </div>
    </div>

  </section>

</main>

<script>
  // App
  var ns = [];
  <% if (typeof notifications !== "undefined") { %>
    ns = <%= JSON.stringify(notifications) %>;
  <% } %>
  var App = new CV.App({
    notifications : ns,
    currentPerson : currentPerson
  });
  App.addInteractiveSidebar();

  var totalFollowing = 0;

  $.ajax({
    type: "GET",
    url:'/<%= organization.profileName %>/voices',
    headers: { 'csrf-token': $('meta[name="csrf-token"]').attr('content') },
    data : {},
    success: function(data) {
      renderData(data, CV.VoiceCover, 'voices');
    }
  });

  $.ajax({
    type: "GET",
    url:'/<%= organization.profileName %>/followers',
    headers: { 'csrf-token': $('meta[name="csrf-token"]').attr('content') },
    data : {},
    success: function(data) {
      renderData(data, CV.Card, 'followers');
    }
  });

  $.ajax({
    type: "GET",
    url:'/<%= organization.profileName %>/voicesFollowed',
    headers: { 'csrf-token': $('meta[name="csrf-token"]').attr('content') },
    data : {},
    success: function(data) {
      renderFollowing(data, CV.VoiceCover, 'voices-followed');
    }
  });
  $.ajax({
    type: "GET",
    url:'/<%= organization.profileName %>/entitiesFollowed',
    headers: { 'csrf-token': $('meta[name="csrf-token"]').attr('content') },
    data : {},
    success: function(data) {
      renderFollowing(data, CV.Card, 'entities-followed');
    }
  });

  var responsives = {
    'voices'    : null,
    'followers'    : null,
    'voices-followed' : null,
    'entities-followed' : null
  }

  function renderData(data, instance, className){
    $('.profile-menu .counter-' + className).text(data.length);

    var itemsWrapper = document.querySelector('.profile-' + className + '-container');
    var itemsElements = [];

    data.forEach(function(item, index) {
      var itemWidget = new instance({data: item}).render(itemsWrapper);
      itemWidget.element.addClass('id-' + item.id);
      itemsElements.push(itemWidget.el);
    });

    responsives[className] = new CV.ResponsiveWidth({
        container : itemsWrapper,
        items : [].slice.call(itemsElements, 0),
        minWidth : 300
    }).setup();

  }

  function renderFollowing(data, instance, className){
    //console.log('followers: ' + data);
    totalFollowing += data.length;
    $('.profile-menu .counter-following').text(totalFollowing);

    var itemsWrapper = document.querySelector('.profile-following-container .' + className );
    var itemsElements = [];

    data.forEach(function(item, index) {
      var itemWidget = new instance(item).render(itemsWrapper);
      itemWidget.element.addClass('id-' + item.id);
      itemsElements.push(itemWidget.el);
    });

    responsives[className] = new CV.ResponsiveWidth({
        container : itemsWrapper,
        items : [].slice.call(itemsElements, 0),
        minWidth : 300
    }).setup();

  }

  var isOrganizationOwner = false;

  var currentOrganization = <%= JSON.stringify(organization) %>;
  if (currentPerson) {
    currentPerson.ownedOrganizations.forEach(function(org){
      if (currentOrganization.id == org.id){
        isOrganizationOwner = true;
      }
    });
  }

  if (!isOrganizationOwner){
    createControls();
  }

  //*********************************************************
  //********************* createControls ********************
  //*********************************************************

  function createControls(){
    var followLabel;
    if ('<%= JSON.stringify(organization.followed) %>' == 'true' ){
      followLabel = 'Following';
    } else {
      followLabel = 'Follow';
    }

    var buttonFollow = new CV.Button({
        style   : 'small',
        type    : 'single',
        label   : followLabel,
        name    : 'buttonFollow',
    }).render(document.querySelector('.profile-actions .p-buttons'));

      //Normal
    var belongsTo = false;

    currentPerson.organizationIds.forEach(function(orgId){

      if (orgId == currentOrganization.id) {
        belongsTo = true;
      };

    });



    var profileOptions = {};

    if (belongsTo == false) {
      var profileOptions = {
        "1": {label: 'Request Membership', name: 'request', icon: 'user'},
        "2": {label: 'Report/Claim', name: 'report', icon: 'info'}
      };
    } else{
      var profileOptions = {
        "2": {label: 'Report/Claim', name: 'report', icon: 'info'}
      };
    }


    var profileSettings = new CV.Select({
      label     : '',
      style     : 'small is-settings',
      className : '-inline-block',
      name      : 'select',
      options   : profileOptions,
      type      : 'icon',
      icon      : 'settings'
    }).render(document.querySelector('.profile-actions .p-select'));

    //********************* IsAnonymous ***********************

    if (currentPerson && currentPerson.isAnonymous) {
      buttonActions.disable();
      profileSettings.disable();

      var tooltipEl = $('<span class="ui-tooltip -top">To message or follow others and to see your messages please turn Anonymous mode off.</span>')
      $('.profile-actions').addClass('ui-has-tooltip').append(tooltipEl);

    } else {

      buttonFollow.element.on('click', function(){
        followEntity();
      });

      if (belongsTo == false) {

        // select actions
        profileSettings.request.on('click', function(){
          var requestMembershipModal = new CV.UI.Modal({
            title : 'Request Membership',
            name : 'requestMembershipModal',
            action : CV.RequestMembership,
            width : 650,
            data : {
              orgId : currentOrganization.id,
              profileName : currentOrganization.profileName
            }
          }).render(document.body);

          requestAnimationFrame(function() {
            requestMembershipModal.activate();
          });
        });

      }

      profileSettings.report.on('click', function(){
        reportModal.show();
      });
    }

    //*********************** Functions **************************
    function followEntity(){
      $.ajax({
        type: "GET",
        url:'/<%= organization.profileName %>/follow',
        headers: { 'csrf-token': $('meta[name="csrf-token"]').attr('content') },
        data : {},
        dataType : "json",
        success: function(data) {
          if (data.status == 'followed'){
            buttonFollow.element.text('Following');
          } else if (data.status == 'unfollowed'){
            buttonFollow.element.text('Follow');
          }
        }
      });
    }


    //*********************** Modals **************************

    var reportModal = new CV.Modal({
      style       : '',
      type        : '',
      title       : 'Report/Claim',
      name        : 'reportModal',
      action      : CV.Report,
      width       : 650,
    });

  }//createControls

// Following options
var followOptions = {
  "1": {label: 'Users', name: 'entities'},
  "2": {label: 'Voices', name: 'voices'}
};

var followSelect = new CV.Select({
  label     : 'Users',
  style     : 'tiny',
  className : '-inline-block',
  name      : 'select',
  options   : followOptions
}).render(document.querySelector('.entities-voices-select'));

followSelect.entities.on('click', function(){
  $('.entities-followed').show();
  $('.voices-followed').hide();
  refreshItems();
});

followSelect.voices.on('click', function(){
  $('.entities-followed').hide();
  $('.voices-followed').show();
  refreshItems();
});

  function refreshItems(){
    responsives['voices'].setup();
    responsives['followers'].setup();
    responsives['voices-followed'].setup();
    responsives['entities-followed'].setup();
  }


  //*********************************************************
  //*********************** Menu ****************************
  //*********************************************************

  $( document ).ready(function() {

    createMenuActions('.profile-menu', '.profile-menu-content');

    function createMenuActions(menuContainer, contentContainer){
      $( menuContainer ).find('.-menu-tab').each(function( index ) {
        var elContent = $( contentContainer + ' .-menu-tab-content:nth-child(' + (index + 1) + ')');
        $(this).on('click', createCallback(this, index, elContent, menuContainer, contentContainer));
      });
    }

    function createCallback( tab, index, elContent, menuContainer, contentContainer ){
      return function(){
        $(menuContainer + ' .-menu-tab').removeClass('active');
        $(this).addClass('active');
        $(contentContainer + ' .-menu-tab-content').removeClass('active');
        $(elContent).addClass('active');
        refreshItems();
      }
    }



  });

</script>
